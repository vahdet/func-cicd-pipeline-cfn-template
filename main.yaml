Description:
  Root Stack for Function Pipeline

Parameters:
  Project:
    Description: Project name to be used in resource naming (e.g. project name)
    Type: String
    MinLength: 3
    MaxLength: 16
    Default: my-func-proj
    ConstraintDescription: must be between 3 and 10 characters.
  Environment:
    Description: An environment name that will be added to resource names
    Type: String
    AllowedValues:
      - dev
      - test
      - prod
    Default: dev
    ConstraintDescription: must specify 'dev', 'test' or 'prod'.
  FunctionName:
    Description: Name of the Lambda Function (e.g. "path-finder")
    Type: String
    MinLength: 3
    MaxLength: 16
    Default: myFunc
    ConstraintDescription: must be between 3 and 10 characters.
  RepositoryURL:
    Description: Github Repository 
    Type: String
    AllowedPattern: "^(https?|ftp|file)://[-a-zA-Z0-9+&@#/%?=~_|!:,.;]*[-a-zA-Z0-9+&@#/%=~_|]"
    Default: https://github.com/vahdet/python-lambda-template
    ConstraintDescription: must be a valid URL.
  Branch:
    Description: The branch of the Github repository
    Type: String
    Default: master
  CfnTemplateS3BucketName:
    Description: The bucket name at which the templates (like these) reside
    Type: String
  GitHubOwner:
    Type: String
    Default: vahdet
  GitHubOAuthToken:
    Type: String
    NoEcho: true
    MinLength: 40
    MaxLength: 40
    AllowedPattern: "[a-z0-9]*"
  BackendServiceBaseURL:
    Description: The base URL for the backed service of the function
    Type: String
    AllowedPattern: "^(https?|ftp|file)://[-a-zA-Z0-9+&@#/%?=~_|!:,.;]*[-a-zA-Z0-9+&@#/%=~_|]"
    ConstraintDescription: must be a valid URL.

Resources:
  # Nested Stacks
  IAM:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${CfnTemplateS3BucketName}.s3.${AWS::Region}.amazonaws.com/iam.yaml
      Parameters:
        Project: !Ref Project
        Environment: !Ref Environment
  Storage:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${CfnTemplateS3BucketName}.s3.${AWS::Region}.amazonaws.com/storage.yaml
      Parameters:
        Project: !Ref Project
        Environment: !Ref Environment
        LambdaArtifactStoreBucketName: !Sub ${Project}-${Environment}-build-artifacts
  Pipeline:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub https://${CfnTemplateS3BucketName}.s3.${AWS::Region}.amazonaws.com/pipeline.yaml
      Parameters:
        Project: !Ref Project
        Environment: !Ref Environment
        Branch: !Ref Branch
        GitHubOwner: !Ref GitHubOwner
        GitHubOAuthToken: !Ref GitHubOAuthToken
        LambdaArtifactStoreBucket:
          Fn::GetAtt: [Storage, Outputs.LambdaArtifactStoreBucket]
        CodeBuildRoleArn:
          Fn::GetAtt: [IAM, Outputs.CodeBuildRoleArn]
        CodePipelineRoleArn:
          Fn::GetAtt: [IAM, Outputs.CodePipelineRoleArn]
        CloudFormationLambdaManagerRoleArn:
          Fn::GetAtt: [IAM, Outputs.CloudFormationLambdaManagerRoleArn]
        # Lambda-specific
        FunctionName: !Sub ${Environment}-${FunctionName}
        Repository: !Ref RepositoryURL
        BackendServiceBaseURL: !Ref BackendServiceBaseURL
